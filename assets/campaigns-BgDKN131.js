import{q as F,u as G,k as N,r as d,K as v,B as x,C as H,z as g,D as o,s as y,V as h,E as K,H as R,I as w,W as V,y as b,A as D,X as W,J as X}from"./index-DtLgEWRs.js";const z=F("campaigns",()=>{const r=G(),E=N(),c=d([]),u=d([]),m=d(null),n=d(!1),t=d(null);let i=null,l=null;const S=v(()=>c.value),M=v(()=>u.value),A=v(()=>[...c.value,...u.value]);function q(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let a="";for(let s=0;s<5;s++)a+=e.charAt(Math.floor(Math.random()*e.length));return a}async function j(e){if(!r.userId)throw new Error("Not authenticated");if(!E.isGM)throw new Error("Только Game Master может создавать кампании");try{n.value=!0,t.value=null;const a={name:e.trim(),createdAt:x(),masterId:r.userId,masterEmail:r.userEmail,players:[],joinCode:q(),mapId:null,status:"active"},s=await H(g(o,"campaigns"),a);return console.log("Campaign created with ID:",s.id),{id:s.id,...a}}catch(a){throw console.error("Failed to create campaign:",a),t.value=a.message,a}finally{n.value=!1}}async function T(e){if(!r.userId)throw new Error("Not authenticated");try{n.value=!0,t.value=null;const a=y(g(o,"campaigns"),h("joinCode","==",e.toUpperCase().trim())),s=await K(a);if(s.empty)throw new Error("Кампания с таким кодом не найдена");const p=s.docs[0],f=p.data();if(f.masterId===r.userId)throw new Error("Вы уже мастер этой кампании");if(f.players?.includes(r.userId))throw new Error("Вы уже участвуете в этой кампании");return await R(w(o,"campaigns",p.id),{players:V(r.userId)}),console.log("Joined campaign:",p.id),{id:p.id,...f}}catch(a){throw console.error("Failed to join campaign:",a),t.value=a.message,a}finally{n.value=!1}}function C(){if(!r.userId)return;i&&i();const e=y(g(o,"campaigns"),h("masterId","==",r.userId),b("createdAt","desc"));i=D(e,a=>{c.value=a.docs.map(s=>({id:s.id,...s.data()}))},a=>{console.error("Master campaigns subscription error:",a),t.value=a.message})}function I(){if(!r.userId)return;l&&l();const e=y(g(o,"campaigns"),h("players","array-contains",r.userId),b("createdAt","desc"));l=D(e,a=>{u.value=a.docs.map(s=>({id:s.id,...s.data()}))},a=>{console.error("Player campaigns subscription error:",a),t.value=a.message})}function J(){C(),I()}async function P(e){try{n.value=!0;const a=await W(w(o,"campaigns",e));if(a.exists())return m.value={id:a.id,...a.data()},m.value;throw new Error("Кампания не найдена")}catch(a){throw t.value=a.message,a}finally{n.value=!1}}async function U(e){try{n.value=!0,await X(w(o,"campaigns",e)),console.log("Campaign deleted:",e)}catch(a){throw t.value=a.message,a}finally{n.value=!1}}function B(){i&&(i(),i=null),l&&(l(),l=null),c.value=[],u.value=[],m.value=null,t.value=null}return{campaigns:c,playerCampaigns:u,currentCampaign:m,loading:n,error:t,myCampaigns:S,joinedCampaigns:M,allMyCampaigns:A,createCampaign:j,joinCampaign:T,subscribeToMasterCampaigns:C,subscribeToPlayerCampaigns:I,subscribeToAllCampaigns:J,getCampaign:P,deleteCampaign:U,clearCampaigns:B}});export{z as u};
